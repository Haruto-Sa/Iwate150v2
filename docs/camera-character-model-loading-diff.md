# cameraで表示できてcharacterで表示しづらい理由

## 概要

このドキュメントは、`/camera` と `/character` で3Dモデルの表示安定性が異なる理由を、実装差分ベースで整理したものです。

## URL候補順序の違い

- camera
  - URL解決時に複数経路を用意し、失敗時に別候補へ進みやすい構成。
  - ローカル `/public/models` 参照も使えるため、Storage側の一時失敗に強い。
- character（修正前）
  - 候補順序とフォールバック経路がcameraと揃っておらず、signed失敗時に待ち時間が伸びやすかった。
- character（修正後）
  - `signed URL` を先に試行し、失敗時は `/public/models` を次候補として利用する。

## ロード開始タイミングの違い

- camera
  - モデルは選択時オンデマンドで読み込み。
  - 画面に必要なモデルだけを遅延ロードするため、同時負荷を抑えやすい。
- character
  - 初期表示時に選択中キャラを即ロードする。
  - 選択切替ごとに再ロードが発生するため、候補順序とタイムアウト設計の影響を受けやすい。

## タイムアウト・リトライ戦略の違い

- camera
  - モデルロード失敗時の再試行が比較的軽量で、ユーザー操作で再選択もしやすい。
- character（修正前）
  - リモート候補待ち時間が長めで、失敗確定まで時間がかかるケースがあった。
- character（修正後）
  - リモート候補のタイムアウトを短縮。
  - `/character` 呼び出し側で候補ごとの再試行回数を抑え、次候補への遷移を速くした。

## 失敗時フォールバック経路の違い

- camera
  - signed取得失敗時でも別候補（特にローカル）へ到達しやすい。
- character（修正前）
  - signed運用時にpublic URL経由の失敗を挟み、ローカル到達まで遅延することがあった。
- character（修正後）
  - signed運用時にsignedでないStorage URLは候補から除外し、`/public/models` へ直接フォールバックする。

## 今回の修正後フロー

1. `/character` は選択中キャラのみ読み込む。
2. 候補順序は `signed URL` → `/public/models`。
3. リモート失敗時は短い待機で次候補へ進む。
4. `/spot` のルート検索はOpenStreetMap主系へ戻し、現在地未取得時のみGoogle Mapsへ切替。

## 補足（アセット整合性）

OBJ/MTL運用では、OBJ内 `mtllib` 記述と実ファイル名の不一致があるとMTL読込が失敗する。
この場合でもOBJ単体で表示できる実装にしておくと、表示継続性を確保しやすい。
