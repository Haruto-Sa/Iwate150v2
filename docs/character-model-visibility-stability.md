# Character 3Dモデル表示安定化

## 機能概要
- `/character` で 3D モデル表示の開始条件を改善し、Storage URL 解決待ちでもローカル `public/models` を優先して即時表示するようにした。
- モデル URL 解決とサムネイル URL 解決を分離し、サムネイル取得遅延が 3D 描画をブロックしないようにした。
- `CharacterViewer` のモデルローダーを強化し、候補ごとに再試行しながら `MTL+OBJ -> OBJ単体` フォールバックを行うようにした。
- WebGL 初期化失敗を明示的にハンドリングし、描画不能環境で原因を UI に表示するようにした。
- モデル中心合わせを `updateMatrixWorld(true)` 前提の手順に固定化し、毎回ビューワー中心に表示されるようにした。
- コンテナサイズ変化への追従を `ResizeObserver` ベースへ変更し、モバイル回転時の崩れを抑制した。

## 技術的な設計判断とその理由
- **ローカル候補を先に描画する**
  - `public/models` 配信は Supabase 接続状態に依存しないため、最初の表示成功率を最優先できる。
- **Storage 解決をバックグラウンド化する**
  - リモート URL の取得失敗・遅延時でもローカル候補で表示を継続できるようにするため。
- **候補ごとのリトライ + フォールバック**
  - 一時的なネットワーク不調や CDN レイテンシに対して、即失敗確定を避けるため。
- **ローカル/リモートでタイムアウトを分離**
  - ローカルは短く、リモートは長めに取り、不要な失敗判定を減らすため。
- **中心合わせを行列更新後に実施**
  - スケールや回転適用後の実体バウンディングボックスで中心計算しないと、見切れやオフセットが発生しやすいため。
- **ResizeObserver を採用**
  - `window.resize` のみでは拾えない親コンテナのレイアウト変化にも追従するため。

## 使用している Supabase テーブル
- なし（本修正は `/character` のクライアント描画ロジックと Storage URL 解決フローのみ）

## 関連ファイルパス一覧
- `src/app/character/page.tsx`
- `src/components/character/CharacterViewer.tsx`
- `docs/character-model-visibility-stability.md`

## 検証手順
1. 開発サーバーを起動する。
```bash
bun run dev
```
2. `/character` を開き、初期キャラクターのモデルが中央表示されることを確認する。
3. 全キャラを順に切り替え、表示失敗せず中央表示されることを確認する。
4. ネットワークを遅延させた状態でも、ローカル候補で表示が継続することを確認する。
5. 画面回転（スマホ）やウィンドウリサイズ（PC）後も、モデルが見切れず表示されることを確認する。
6. WebGL 無効環境では、モデル無表示ではなくエラーメッセージが表示されることを確認する。
